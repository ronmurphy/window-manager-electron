<html lang="en"><head><div style="display: none;"></div>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Site Grid Manager</title>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Outlined" rel="stylesheet">
    <style>
        :root {
            --primary-color: #2196F3;
            --background-color: #f5f5f5;
            --card-color: #ffffff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: Arial, sans-serif;
            background-color: var(--background-color);
            padding: 20px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .controls {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .btn {
            padding: 10px 20px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .btn:hover {
            opacity: 0.9;
        }

        .toggle-btn {
            opacity: 0.6;
            transition: opacity 0.3s ease;
        }

        .toggle-btn.active {
            opacity: 1;
            background-color: var(--primary-color);
        }

        .delete-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(255, 0, 0, 0.8);
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            color: white;
            padding: 0;
        }

        .delete-btn .material-icons-outlined {
            font-size: 16px;
        }

        .site-card {
            position: relative;
        }

        .site-card:hover .delete-btn {
            display: flex;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 20px;
            transition: all 0.3s ease;
            border: 2px solid var(--primary-color);
            border-radius: 8px;
            padding: 20px;
        }

        .grid.list {
            grid-template-columns: 1fr;
        }

        .grid.masonry {
            columns: 4;
            column-gap: 20px;
            padding: 20px;
        }

        .grid.masonry .site-card {
            break-inside: avoid;
            margin-bottom: 20px;
            transform: rotate(calc(var(--rotation) * 1deg));
            --rotation: 0;
        }

        .grid.masonry .site-card:nth-child(odd) {
            --rotation: 1;
        }

        .grid.masonry .site-card:nth-child(even) {
            --rotation: -1;
        }

        .grid.mosaic {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            grid-auto-rows: 120px;
            gap: 15px;
            padding: 20px;
        }

        .grid.mosaic .site-card:nth-child(6n+1) {
            grid-column: span 2;
            grid-row: span 2;
        }

        .grid.mosaic .site-card:nth-child(8n+3) {
            grid-column: span 3;
        }

        .grid.mosaic .site-card:nth-child(12n+8) {
            grid-row: span 2;
        }

        .grid.mosaic .site-card {
            height: 100%;
        }

        .grid.carousel {
            display: flex;
            overflow-x: auto;
            grid-template-columns: none;
            scroll-snap-type: x mandatory;
            scroll-behavior: smooth;
            padding: 20px;
            gap: 20px;
            height: 300px;
            align-items: center;
        }

        .grid.carousel .site-card {
            flex: 0 0 250px;
            scroll-snap-align: start;
            transform-origin: center;
            transition: all 0.3s;
            position: relative;
        }

        .grid.carousel .site-card:hover {
            transform: scale(1.1) translateY(-10px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
            z-index: 1;
        }

        .grid.carousel::after {
            content: '';
            flex: 0 0 20px;
        }

        /* Animation classes */
        .site-card.flip-horizontal {
            animation: flipHorizontal 1s;
        }

        .site-card.flip-vertical {
            animation: flipVertical 1s;
        }

        .site-card.fade {
            animation: fadeInOut 1.5s;
        }

        .site-card.shake {
            animation: shake 0.5s;
        }

        .site-card.float {
            position: relative;
        }

        .site-card.float::before {
            content: '';
            position: absolute;
            width: 32px;
            height: 32px;
            background-size: contain;
            background-repeat: no-repeat;
            opacity: 0.2;
            animation: float 3s infinite;
            z-index: 0;
        }

        @keyframes flipHorizontal {
            0% { transform: rotateY(0); }
            100% { transform: rotateY(360deg); }
        }

        @keyframes flipVertical {
            0% { transform: rotateX(0); }
            100% { transform: rotateX(360deg); }
        }

        @keyframes fadeInOut {
            0% { opacity: 1; }
            50% { opacity: 0; }
            100% { opacity: 1; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        @keyframes float {
            0%, 100% { transform: translateY(0) scale(1.5); }
            50% { transform: translateY(-10px) scale(1.8); }
        }

        .grid.compact {
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 5px;
            padding: 10px;
        }

        .grid.compact .site-card {
            padding: 8px;
            font-size: 0.8em;
        }

        .grid.compact .site-icon {
            width: 24px;
            height: 24px;
        }

        .grid.compact .site-url {
            display: none;
        }

        .site-card {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            cursor: move;
            text-decoration: none;
            color: inherit;
            transition: background-color 0.3s ease;
        }

        .site-card.list {
            flex-direction: row;
            justify-content: flex-start;
            gap: 20px;
        }

        .site-url {
            font-size: 0.8em;
            color: #666;
            word-break: break-all;
            text-align: center;
        }

        .site-card.list .site-url {
            text-align: left;
        }

        .site-icon {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--card-color);
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 500px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-body {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        input[type="url"] {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .preview {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        .status-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            font-size: 0.9em;
            box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
            z-index: 100;
        }

        body {
            margin-bottom: 50px;
        }
    </style>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><style>
                        body, html {
                            touch-action: manipulation;
                            user-select: none;
                            -webkit-user-select: none;
                            -webkit-touch-callout: none;
                            -webkit-tap-highlight-color: rgba(0,0,0,0);
                        }
                    </style></head>
<body>
    <div class="header">
        <div class="controls">
            <button class="btn" id="addSiteBtn" title="Add Site">
                <span class="material-icons-outlined">add</span>
            </button>
            <button class="btn" id="toggleViewBtn">
                <span class="material-icons-outlined">grid_view</span>
            </button>
            <button class="btn" id="clearGridBtn" title="Clear All">
                <span class="material-icons-outlined">delete_sweep</span>
            </button>
        </div>
        <div class="controls">
            <button class="btn toggle-btn" id="dragToggleBtn" title="Enable Drag">
                <span class="material-icons-outlined">drag_indicator</span>
            </button>
            <button class="btn toggle-btn" id="colorToggleBtn" title="Use Colors">
                <span class="material-icons-outlined">palette</span>
            </button>
            <button class="btn toggle-btn" id="animationToggleBtn" title="Toggle Animations">
                <span class="material-icons-outlined">animation</span>
            </button>
        </div>
    </div>

    <div class="grid" id="siteGrid"></div>

    <div class="status-bar">
        <span id="gridStatus">Grid Style: Grid</span>
        <span id="colorStatus">Color Scheme: None</span>
        <span id="animationStatus">Animation: None</span>
    </div>

    <div class="modal" id="addSiteModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Add New Site</h2>
                <button class="btn" id="closeModal">
                    <span class="material-icons-outlined">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="siteUrl">Website URL</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="url" id="siteUrl" placeholder="https://example.com" style="flex: 1;">
                        <button class="btn" id="getIconBtn">Get Icon</button>
                    </div>
                </div>
                <div class="preview" id="preview"></div>
            </div>
            <div class="modal-footer">
                <button class="btn" id="closeModalBtn">Close</button>
                <button class="btn" id="addSiteConfirmBtn">Add</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.14.0/Sortable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <script>
        const grid = document.getElementById('siteGrid');
        const addSiteBtn = document.getElementById('addSiteBtn');
        const toggleViewBtn = document.getElementById('toggleViewBtn');
        const dragToggleBtn = document.getElementById('dragToggleBtn');
        const colorToggleBtn = document.getElementById('colorToggleBtn');
        const colorThief = new ColorThief();
        const modal = document.getElementById('addSiteModal');
        const closeModal = document.getElementById('closeModal');
        const closeModalBtn = document.getElementById('closeModalBtn');
        const addSiteConfirmBtn = document.getElementById('addSiteConfirmBtn');
        const siteUrlInput = document.getElementById('siteUrl');
        const preview = document.getElementById('preview');

        let sortable = null;
        let sites = [];

        const gridStyles = ['grid', 'list', 'masonry', 'carousel', 'compact', 'mosaic'];
        const animationStyles = ['none', 'flip-horizontal', 'flip-vertical', 'fade', 'shake', 'float'];
        let currentAnimationStyle = 0;
        let currentGridStyle = 0;

        function toggleView() {
            const items = document.querySelectorAll('.site-card');
            
            // Remove all style classes
            grid.classList.remove(...gridStyles);
            items.forEach(item => item.classList.remove(...gridStyles));
            
            // Cycle to next style
            currentGridStyle = (currentGridStyle + 1) % gridStyles.length;
            
            // Apply new style
            grid.classList.add(gridStyles[currentGridStyle]);
            items.forEach(item => item.classList.add(gridStyles[currentGridStyle]));
            
            // Update status
            document.getElementById('gridStatus').textContent = `Grid Style: ${gridStyles[currentGridStyle].charAt(0).toUpperCase() + gridStyles[currentGridStyle].slice(1)}`;
            
            // Update icon
            const icon = toggleViewBtn.querySelector('.material-icons-outlined');
            const icons = {
                'grid': 'grid_view',
                'list': 'view_list',
                'masonry': 'dashboard',
                'carousel': 'view_carousel',
                'compact': 'apps'
            };
            icon.textContent = icons[gridStyles[currentGridStyle]];
        }

        function toggleDrag(enable) {
            if (enable) {
                sortable = new Sortable(grid, {
                    animation: 150,
                    onEnd: function(evt) {
                        const items = Array.from(grid.children);
                        sites = items.map(item => ({
                            url: item.dataset.url,
                            favicon: item.querySelector('img').src,
                            name: item.querySelector('span').textContent
                        }));
                        localStorage.setItem('sites', JSON.stringify(sites));
                    }
                });
            } else if (sortable) {
                sortable.destroy();
                sortable = null;
            }
        }

        function ensureHttps(url) {
            url = url.trim();
            if (!url.startsWith('http://') && !url.startsWith('https://')) {
                url = 'https://' + url;
            }
            return url;
        }

        function isValidUrl(url) {
            try {
                new URL(url);
                return true;
            } catch {
                return false;
            }
        }

        async function getFavicon(url) {
            if (!isValidUrl(url)) {
                console.error('Invalid URL provided');
                return null;
            }

            const timeout = 30000; // 30 second timeout
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), timeout);

            try {
                const domain = new URL(url).hostname;
                let fallbackIcon = null;
                
                // Try to get iOS icon first
                try {
                    const response = await fetch(url, {
                        signal: controller.signal,
                        method: 'GET',
                        mode: 'cors'
                    });
                    if (response.ok) {
                        const text = await response.text();
                        const parser = new DOMParser();
                        const doc = parser.parseFromString(text, 'text/html');
                        
                        // Try different icon types in order of preference
                        const iconSelectors = [
                            'link[rel="apple-touch-icon"]',
                            'link[rel="apple-touch-icon-precomposed"]',
                            'link[rel="icon"][sizes="32x32"]',
                            'link[rel="shortcut icon"]',
                            'link[rel="icon"]'
                        ];

                        for (const selector of iconSelectors) {
                            const iconLink = doc.querySelector(selector);
                            if (iconLink && iconLink.href) {
                                try {
                                    const iconUrl = new URL(iconLink.href, url).href;
                                    const iconResponse = await fetch(iconUrl, {
                                        signal: controller.signal,
                                        method: 'GET',
                                        mode: 'cors'
                                    });
                                    if (iconResponse.ok && iconResponse.status === 200) {
                                        const blob = await iconResponse.blob();
                                        if (blob.size > 0) {
                                            return iconUrl;
                                        }
                                    }
                                } catch (e) {
                                    console.log(`Could not fetch icon with selector ${selector}`);
                                    continue;
                                }
                            }
                        }
                    }
                } catch (e) {
                    console.log('Could not fetch site HTML or parse iOS icons');
                }

                // Try Google favicon
                try {
                    const googleFavicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=32`;
                    const googleResponse = await fetch(googleFavicon, {
                        signal: controller.signal,
                        method: 'GET',
                        mode: 'cors'
                    });
                    if (googleResponse.ok && googleResponse.status === 200) {
                        const blob = await googleResponse.blob();
                        if (blob.size > 0) {
                            fallbackIcon = googleFavicon;
                        }
                    }
                } catch (e) {
                    console.log('Could not fetch Google favicon, trying next source...');
                }

                // Try favicon.ico directly
                if (!fallbackIcon) {
                    try {
                        const directFavicon = `${new URL(url).origin}/favicon.ico`;
                        const directResponse = await fetch(directFavicon, {
                            signal: controller.signal,
                            method: 'GET',
                            mode: 'cors'
                        });
                        if (directResponse.ok && directResponse.status === 200) {
                            const blob = await directResponse.blob();
                            if (blob.size > 0) {
                                fallbackIcon = directFavicon;
                            }
                        }
                    } catch (e) {
                        console.log('Could not fetch direct favicon, trying next source...');
                    }
                }

                // Try Yandex favicon service
                if (!fallbackIcon) {
                    try {
                        const yandexFavicon = `https://favicon.yandex.net/favicon/${domain}`;
                        const yandexResponse = await fetch(yandexFavicon, {
                            signal: controller.signal,
                            method: 'GET',
                            mode: 'cors'
                        });
                        if (yandexResponse.ok && yandexResponse.status === 200) {
                            const blob = await yandexResponse.blob();
                            if (blob.size > 0) {
                                fallbackIcon = yandexFavicon;
                            }
                        }
                    } catch (e) {
                        console.log('Could not fetch Yandex favicon, trying next source...');
                    }
                }

                // If previous attempts fail, try DuckDuckGo
                if (!fallbackIcon) {
                    try {
                        const duckFavicon = `https://icons.duckduckgo.com/ip3/${domain}.ico`;
                        const duckResponse = await fetch(duckFavicon, {
                            signal: controller.signal,
                            method: 'GET',
                            mode: 'cors'
                        });
                        if (duckResponse.ok && duckResponse.status === 200) {
                            const blob = await duckResponse.blob();
                            if (blob.size > 0) {
                                fallbackIcon = duckFavicon;
                            }
                        }
                    } catch (e) {
                        console.log('Could not fetch DuckDuckGo favicon, trying next source...');
                    }
                }

                // Try to get iOS icon
                if (!fallbackIcon) {
                    try {
                        const response = await fetch(url, {
                            signal: controller.signal,
                            method: 'GET',
                            mode: 'cors'
                        });
                        if (response.ok) {
                            const text = await response.text();
                            const parser = new DOMParser();
                            const doc = parser.parseFromString(text, 'text/html');
                            
                            // Try different icon types in order of preference
                            const iconSelectors = [
                                'link[rel="apple-touch-icon"]',
                                'link[rel="apple-touch-icon-precomposed"]',
                                'link[rel="icon"][sizes="32x32"]',
                                'link[rel="shortcut icon"]',
                                'link[rel="icon"]'
                            ];

                            for (const selector of iconSelectors) {
                                const iconLink = doc.querySelector(selector);
                                if (iconLink && iconLink.href) {
                                    try {
                                        const iconUrl = new URL(iconLink.href, url).href;
                                        const iconResponse = await fetch(iconUrl, {
                                            signal: controller.signal,
                                            method: 'GET',
                                            mode: 'cors'
                                        });
                                        if (iconResponse.ok && iconResponse.status === 200) {
                                            const blob = await iconResponse.blob();
                                            if (blob.size > 0) {
                                                return iconUrl;
                                            }
                                        }
                                    } catch (e) {
                                        console.log(`Could not fetch icon with selector ${selector}`);
                                        continue;
                                    }
                                }
                            }
                        }
                    } catch (e) {
                        console.log('Could not fetch site HTML or parse icons');
                    }
                }
                
                if (!fallbackIcon) {
                    // Use material icon as last resort
                    const materialIcon = document.createElement('span');
                    materialIcon.className = 'material-icons-outlined';
                    materialIcon.textContent = 'public';
                    materialIcon.style.fontSize = '32px';
                    materialIcon.style.color = '#666';
                    
                    preview.innerHTML = '';
                    preview.appendChild(materialIcon);
                    preview.appendChild(document.createTextNode(' Using default icon - no favicon found'));
                    
                    // Convert material icon to data URL
                    const canvas = document.createElement('canvas');
                    canvas.width = 32;
                    canvas.height = 32;
                    const ctx = canvas.getContext('2d');
                    ctx.fillStyle = '#666';
                    ctx.font = '32px "Material Icons Outlined"';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText('public', 16, 16);
                    fallbackIcon = canvas.toDataURL();
                }
                
                return fallbackIcon;
            } catch (error) {
                console.error('Error getting favicon:', error);
                return null;
            } finally {
                clearTimeout(timeoutId);
            }
        }

        async function addSite(url, favicon) {
            const fullDomain = new URL(url).hostname;
            const domain = fullDomain.split('.')[0];
            const displayName = domain.charAt(0).toUpperCase() + domain.slice(1);
            const card = document.createElement('div');
            card.href = url;
            card.target = "_blank";
            card.className = 'site-card' + (grid.classList.contains('list') ? ' list' : '');
            card.dataset.url = url;
            
            const img = document.createElement('img');
            img.className = 'site-icon';
            img.style.width = '32px';
            img.style.height = '32px';
            img.src = favicon;
            img.alt = domain;
            img.crossOrigin = 'Anonymous';
            
            const name = document.createElement('span');
            name.textContent = displayName;

            const urlText = document.createElement('span');
            urlText.className = 'site-url';
            urlText.textContent = url;
            
            card.appendChild(img);
            card.appendChild(name);
            card.appendChild(urlText);
            
            const link = document.createElement('a');
            link.href = url;
            link.target = "_blank";
            link.style.position = 'absolute';
            link.style.inset = '0';
            card.appendChild(link);

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-btn';
            deleteBtn.innerHTML = '<span class="material-icons-outlined">delete</span>';
            deleteBtn.onclick = (e) => {
                e.preventDefault();
                e.stopPropagation();
                card.remove();
                sites = sites.filter(site => site.url !== url);
                localStorage.setItem('sites', JSON.stringify(sites));
            };
            card.appendChild(deleteBtn);
            
            grid.appendChild(card);

            if (colorToggleBtn.classList.contains('active')) {
                img.onload = async () => {
                    try {
                        const color = colorThief.getColor(img);
                        const [r, g, b] = color;
                        
                        switch(currentColorScheme) {
                            case 0: // none
                                card.style.backgroundColor = '';
                                card.style.color = '';
                                break;
                            case 1: // white
                                card.style.backgroundColor = '#ffffff';
                                card.style.color = '#000000';
                                break;
                            case 2: // icon-color
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                                card.style.color = brightness > 128 ? 'black' : 'white';
                                break;
                            case 3: // icon-accent
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                img.style.backgroundColor = `rgba(255, 255, 255, 0.3)`;
                                img.style.padding = '4px';
                                img.style.borderRadius = '4px';
                                break;
                            case 4: // contrast
                                card.style.backgroundColor = `rgb(${255-r}, ${255-g}, ${255-b})`;
                                break;
                            case 5: // gradient
                                card.style.background = `linear-gradient(135deg, rgb(${r}, ${g}, ${b}), rgb(${b}, ${r}, ${g}))`;
                                break;
                            case 6: // pattern
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                card.style.backgroundImage = `radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 10%)`;
                                break;
                            case 7: // monochrome
                                const avg = Math.floor((r + g + b) / 3);
                                card.style.backgroundColor = `rgb(${avg}, ${avg}, ${avg})`;
                                break;
                        }
                    } catch (e) {
                        console.log('Could not extract color from icon');
                    }
                };
            }

            sites.push({ url, favicon, name: domain });
            localStorage.setItem('sites', JSON.stringify(sites));
        }

        // Clear grid button
        const clearGridBtn = document.getElementById('clearGridBtn');
        clearGridBtn.addEventListener('click', () => {
            grid.innerHTML = '';
            sites = [];
            localStorage.setItem('sites', JSON.stringify(sites));
        });

        // Event Listeners
        addSiteBtn.addEventListener('click', () => {
            modal.style.display = 'flex';
        });

        closeModal.addEventListener('click', () => {
            modal.style.display = 'none';
            preview.innerHTML = '';
            siteUrlInput.value = '';
        });

        closeModalBtn.addEventListener('click', () => {
            modal.style.display = 'none';
            preview.innerHTML = '';
            siteUrlInput.value = '';
        });

        const getIconBtn = document.getElementById('getIconBtn');
        
        getIconBtn.addEventListener('click', async () => {
            let url = ensureHttps(siteUrlInput.value);
            siteUrlInput.value = url;
            preview.innerHTML = '';
            
            if (!url) return;
            
            if (!isValidUrl(url)) {
                preview.innerHTML = '<span style="color: red;">Please enter a valid URL (e.g., https://example.com)</span>';
                return;
            }

            preview.innerHTML = '<span>Loading icon...</span>';
            const favicon = await getFavicon(url);
            if (favicon) {
                preview.innerHTML = `
                    <img src="${favicon}" class="site-icon" alt="Site favicon">
                    <span>${new URL(url).hostname}</span>
                `;
            } else {
                preview.innerHTML = '<span style="color: orange;">Could not fetch icon automatically. Click Add to use default icon.</span>';
            }
        });

        addSiteConfirmBtn.addEventListener('click', async () => {
            let url = ensureHttps(siteUrlInput.value);
            siteUrlInput.value = url;
            if (!url) return;

            if (!isValidUrl(url)) {
                preview.innerHTML = '<span style="color: red;">Please enter a valid URL (e.g., https://example.com)</span>';
                return;
            }

            const favicon = await getFavicon(url);
            if (favicon) {
                addSite(url, favicon);
                modal.style.display = 'none';
                preview.innerHTML = '';
                siteUrlInput.value = '';
            }
        });

        toggleViewBtn.addEventListener('click', toggleView);
        dragToggleBtn.addEventListener('click', () => {
            dragToggleBtn.classList.toggle('active');
            toggleDrag(dragToggleBtn.classList.contains('active'));
        });
        
        const colorSchemes = ['none', 'white', 'icon-color', 'icon-accent', 'contrast', 'gradient', 'pattern', 'monochrome', 'pastel', 'neon'];
        let currentColorScheme = 0;
        // Animation toggle button
        const animationToggleBtn = document.getElementById('animationToggleBtn');
        animationToggleBtn.addEventListener('click', () => {
            animationToggleBtn.classList.toggle('active');
            if (animationToggleBtn.classList.contains('active')) {
                currentAnimationStyle = (currentAnimationStyle + 1) % animationStyles.length;
                document.getElementById('animationStatus').textContent = `Animation: ${animationStyles[currentAnimationStyle].charAt(0).toUpperCase() + animationStyles[currentAnimationStyle].slice(1).replace('-', ' ')}`;
                const cards = document.querySelectorAll('.site-card');
                cards.forEach(card => {
                    card.classList.remove(...animationStyles);
                    if (currentAnimationStyle > 0) {
                        card.classList.add(animationStyles[currentAnimationStyle]);
                        if (animationStyles[currentAnimationStyle] === 'float') {
                            const img = card.querySelector('img');
                            card.style.setProperty('--float-icon', `url(${img.src})`);
                        }
                    }
                });
            } else {
                const cards = document.querySelectorAll('.site-card');
                cards.forEach(card => {
                    card.classList.remove(...animationStyles);
                });
            }
        });

        colorToggleBtn.addEventListener('click', () => {
            colorToggleBtn.classList.toggle('active');
            const isActive = colorToggleBtn.classList.contains('active');
            if (isActive) {
                currentColorScheme = (currentColorScheme + 1) % colorSchemes.length;
                document.getElementById('colorStatus').textContent = `Color Scheme: ${colorSchemes[currentColorScheme].charAt(0).toUpperCase() + colorSchemes[currentColorScheme].slice(1)}`;
            } else {
                document.getElementById('colorStatus').textContent = 'Color Scheme: None';
            }
            const cards = document.querySelectorAll('.site-card');
            cards.forEach(async (card) => {
                const img = card.querySelector('img');
                if (isActive) {
                    try {
                        const color = colorThief.getColor(img);
                        card.style.backgroundColor = `rgb(${color[0]}, ${color[1]}, ${color[2]})`;
                        const [r, g, b] = color;
                        
                        switch(currentColorScheme) {
                            case 0: // none
                                card.style.backgroundColor = '';
                                card.style.color = '';
                                break;
                            case 1: // white
                                card.style.backgroundColor = '#ffffff';
                                card.style.color = '#000000';
                                break;
                            case 2: // icon-color
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                const brightness = (r * 299 + g * 587 + b * 114) / 1000;
                                card.style.color = brightness > 128 ? 'black' : 'white';
                                break;
                            case 3: // icon-accent
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                img.style.backgroundColor = `rgba(255, 255, 255, 0.3)`;
                                img.style.padding = '4px';
                                img.style.borderRadius = '4px';
                                break;
                            case 4: // contrast
                                card.style.backgroundColor = `rgb(${255-r}, ${255-g}, ${255-b})`;
                                break;
                            case 5: // gradient
                                card.style.background = `linear-gradient(135deg, rgb(${r}, ${g}, ${b}), rgb(${b}, ${r}, ${g}))`;
                                break;
                            case 6: // pattern
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                card.style.backgroundImage = `radial-gradient(circle at 30% 30%, rgba(255,255,255,0.2) 0%, transparent 10%)`;
                                break;
                            case 7: // monochrome
                                const avg = Math.floor((r + g + b) / 3);
                                card.style.backgroundColor = `rgb(${avg}, ${avg}, ${avg})`;
                                break;
                            case 8: // pastel
                                card.style.backgroundColor = `rgb(${Math.min(255, r + 50)}, ${Math.min(255, g + 50)}, ${Math.min(255, b + 50)})`;
                                break;
                            case 9: // neon
                                card.style.backgroundColor = `rgb(${r}, ${g}, ${b})`;
                                card.style.boxShadow = `0 0 10px rgb(${r}, ${g}, ${b})`;
                                break;
                        }
                    } catch (e) {
                        console.log('Could not extract color from icon');
                    }
                } else {
                    card.style.backgroundColor = '';
                    card.style.color = '';
                }
            });
        });

        // Load saved sites
        const savedSites = JSON.parse(localStorage.getItem('sites') || '[]');
        savedSites.forEach(site => addSite(site.url, site.favicon));
    </script></body></html>